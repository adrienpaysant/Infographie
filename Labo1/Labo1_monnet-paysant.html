
<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="./Labo1_monnet_paysant/stylesheet.css">
		<script src="./Labo1_monnet_paysant/commonFunctions.js"></script>
		<script src="./Labo1_monnet_paysant/gl-matrix-min.js"></script>
		<script src="./Labo1_monnet_paysant/webglTools.js"></script>
		<script id="shader-vs" type="x-shader/x-vertex">
		    attribute vec3 aVertexNormal;
			attribute vec3 aVertexPosition;
			attribute vec2 aTextureCoord;
			attribute vec3 aTangent;
			uniform mat4 uNMatrix;
			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;
			uniform vec3 uLightPosition;
			varying vec2 vTextureCoord;
			varying vec3 vNormal;
			varying vec3 vLightRay;
			varying vec3 vEyeVec;
			varying mat3 tbn;
			void main(void) {
				vTextureCoord = aTextureCoord;
				vec4 vertex = uMVMatrix * vec4(aVertexPosition, 1.0);
				vNormal = vec3(uNMatrix * vec4(aVertexNormal, 1.0));
			    vec4 vTangent = normalize( uNMatrix * vec4(aTangent, 1.0) );
			    vec3 vBitangent = normalize(cross( vNormal, vTangent.xyz ));
			    tbn = mat3(vTangent, vBitangent, vNormal);
				vLightRay = vertex.xyz - uLightPosition;
				vEyeVec = -vec3(vertex.xyz);
				gl_Position = uPMatrix * vertex;
			}
		</script>
		<script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif
			uniform float uShininess;
			uniform float lightIntensity;
			uniform vec3 uLightAmbient;
			uniform vec3 uMaterialDiffuse;
			uniform vec3 uMaterialSpecular;
			uniform bool usingColorMap;
			uniform bool usingNormalMap;
			uniform bool usingSpecularMap;
			uniform sampler2D uColorTexture;
			uniform sampler2D uColorDirt;
			uniform sampler2D uNormalMap;
			uniform sampler2D uSpecularMap;
			varying vec2 vTextureCoord;
			varying vec3 vNormal;
			varying vec3 vLightRay;
			varying vec3 vEyeVec;
			varying mat3 tbn;
			void main(void) {
				float squaredDistanceToLight = vLightRay.x*vLightRay.x+vLightRay.y*vLightRay.y+vLightRay.z*vLightRay.z;
				vec3 L = normalize(vLightRay);
				vec3 N ;
				vec2 mapCoord = vec2(vTextureCoord.s, vTextureCoord.t);
				vec3 baseColor = vec3(1.0,1.0,1.0);
				vec3 normalVector = vNormal;
				vec3 specVector ;
				vec3 finalColor = uLightAmbient;
				if( usingColorMap ) baseColor = vec3(texture2D(uColorTexture, mapCoord))/*+vec3(texture2D(uColorDirt, mapCoord))*/;//TODO
				//todo moduler par un pourcentage
				else baseColor = vec3(0.5, 0.5, 0.5);
				if( usingNormalMap ){
					normalVector = normalize(vec3(2.0*texture2D(uNormalMap, mapCoord).rgb - 1.0));
					normalVector = tbn * normalVector;
				}
				if( usingSpecularMap ) specVector = vec3(texture2D(uSpecularMap, mapCoord));
				else specVector = vec3( 0.0, 0.0, 0.0 );
				if( usingNormalMap || usingSpecularMap ){
					N = normalize(normalVector);
					float lambertTerm = dot(N,-L);
					float specular = 0.0;
					if(lambertTerm > 0.0)
					{
						finalColor +=  uMaterialDiffuse * lambertTerm;
						vec3 E = normalize(vEyeVec);
						vec3 R = reflect(L, N);
						specular = pow( max(dot(R, E), 0.0), uShininess);
						finalColor += specVector * uMaterialSpecular * specular;
					}
				}
				finalColor *= baseColor.xyz * lightIntensity / squaredDistanceToLight;
				gl_FragColor = vec4(finalColor, 1.0);
			}
		</script>
		<script>
            var hAngle=0;
			var vAngle=0;
			var currentColorMapID    = 1;
			var currentNormalMapID   = 1;
			var currentSpecularMapID = 1;
			const M_PI = 3.1415926535897932384626433832795;
			const M_2PI = 2.0*M_PI;
			const maxSample = 11;
			var normalBuffer = null;
			var vertexBuffer = null;
			var indexBuffer  = null;
			var textCoordsBuffer = null;
			var tangentsBuffer = null;
			var texColorTab = new Array();
			var texNormalTab = new Array();
			var texBrokenTab  = new Array();
			var indices    = [];
			var vertices   = [];
			var textCoords = [];
			var mvMatrix = mat4.create();
			var pMatrix  = mat4.create();
			var nMatrix  = mat4.create();
			var rotLight = 0;
			var lightRotRadius = 2.0
			var currentLightIntensity = 10.0;
			var objectInRotation = 1;
			var quadAngle = 45;
			var brokenGlassIntensity=50.0;
			function initShaderParameters(prg){
				prg.vertexNormalAttribute   = glContext.getAttribLocation(prg, "aVertexNormal");
				glContext.enableVertexAttribArray(prg.vertexNormalAttribute);
				prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
				glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
				prg.textureCoordsAttribute  = glContext.getAttribLocation(prg, "aTextureCoord");
				glContext.enableVertexAttribArray(prg.textureCoordsAttribute);
				prg.tangentsAttribute  = glContext.getAttribLocation(prg, "aTangent");
				glContext.enableVertexAttribArray(prg.tangentsAttribute);
				prg.pMatrixUniform          = glContext.getUniformLocation(prg, 'uPMatrix');
				prg.mvMatrixUniform         = glContext.getUniformLocation(prg, 'uMVMatrix');
				prg.nMatrixUniform	        = glContext.getUniformLocation(prg, "uNMatrix");
			    prg.lightPositionUniform    = glContext.getUniformLocation(prg, 'uLightPosition');
			    prg.shininessUniform        = glContext.getUniformLocation(prg, 'uShininess');
			    prg.lightIntensityUniform   = glContext.getUniformLocation(prg, 'lightIntensity');
			    prg.ambUniform     = glContext.getUniformLocation(prg, 'uLightAmbient');
			    prg.difUniform  = glContext.getUniformLocation(prg, 'uMaterialDiffuse');
			    prg.specUniform = glContext.getUniformLocation(prg, 'uMaterialSpecular');
				prg.usingColorMapUniform    = glContext.getUniformLocation(prg, 'usingColorMap');
				prg.usingNormalMapUniform   = glContext.getUniformLocation(prg, 'usingNormalMap');
				prg.usingSpecularMapUniform = glContext.getUniformLocation(prg, 'usingSpecularMap');
				prg.uColorTexture 			= glContext.getUniformLocation(prg, "uColorTexture");
				prg.uColorDirt 			= glContext.getUniformLocation(prg, "uColorDirt");
				prg.uNormalMap   			= glContext.getUniformLocation(prg, "uNormalMap");
				prg.uSpecularMap   			= glContext.getUniformLocation(prg, "uSpecularMap");
			}
			function initBuffers(){
				vertices = [ -6.0, -6.0, 0.0,
							  6.0, -6.0, 0.0,
							 -6.0,  6.0, 0.0,
							  6.0,  6.0, 0.0 ];
				normals = [ 0, 0, 1,
							0, 0, 1,
							0, 0, 1,
							0, 0, 1];
				indices = [ 0, 1, 2, 3 ];
				textCoords = [  -2.5, -2.5,
								3.5, -2.5,
								-2.5, 3.5,
								3.5, 3.5 ];
				tangents = [ 1.0, 0.0, 0.0,
							 1.0, 0.0, 0.0,
							 1.0, 0.0, 0.0,
							 1.0, 0.0, 0.0];
				normalBuffer     = getArrayBufferWithArray(normals);
				vertexBuffer     = getArrayBufferWithArray(vertices);
				indexBuffer      = getIndexBufferWithIndices(indices);
				textCoordsBuffer = getArrayBufferWithArray(textCoords);
				tangentsBuffer = getArrayBufferWithArray(tangents);
			}
			function initMaterialProperties(){
				glContext.uniform3f(prg.ambUniform, 0.5, 0.5, 0.5); 
				let intens =brokenGlassIntensity/100;
				
				glContext.uniform3f(prg.difUniform, intens, intens, intens); 
				
				glContext.uniform3f(prg.specUniform, 0.2, 0.2, 0.2);
				glContext.uniform1f(prg.shininessUniform, 1.0);
					
			}
			function setLightPositionAndIntensity()
			{
				if( document.getElementById("animateCheckBox").checked )
				{
					rotLight += 0.03;
					if( rotLight>M_2PI) rotLight = -M_2PI;
				}
				glContext.uniform3f(prg.lightPositionUniform, lightRotRadius*Math.cos(rotLight), lightRotRadius*Math.sin(rotLight), 1.0);
				glContext.uniform1f(prg.lightIntensityUniform, currentLightIntensity );
			}
			function drawScene(){
				glContext.clearColor(0.990, 1.00, 1.00, 1.0);
				glContext.enable(glContext.DEPTH_TEST);
				glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
				glContext.viewport( 0.0, 0.0, c_width, c_height);
				mat4.perspective(pMatrix, degToRad(60), c_width / c_height, 0.1, 1000.0);
				mat4.identity(mvMatrix);
                mat4.translate(mvMatrix, mvMatrix, [0.0, 0.0, -2.0]);
                
                //rotation selon les deux axes
				mat4.rotate(mvMatrix,mvMatrix,-hAngle*3.14/180.0, [1,0,0]);
                mat4.rotate(mvMatrix,mvMatrix,-vAngle*3.14/180.0, [0,1,0]);
                
				setLightPositionAndIntensity();
				glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
				glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvMatrix);
			    mat4.copy(nMatrix, mvMatrix);
			    mat4.invert(nMatrix, nMatrix);
			    mat4.transpose(nMatrix, nMatrix);
			    glContext.uniformMatrix4fv(prg.nMatrixUniform, false, nMatrix);
				initMaterialProperties();
				glContext.uniform1i(prg.usingColorMapUniform, document.getElementById( "useColorMapCheckBox" ).checked);
				glContext.uniform1i(prg.usingNormalMapUniform, document.getElementById( "userBrokenGlassCheckBox" ).checked);
				
				glContext.bindBuffer(glContext.ARRAY_BUFFER, normalBuffer);
				glContext.vertexAttribPointer(prg.vertexNormalAttribute, 3, glContext.FLOAT, false, 0, 0);

				glContext.bindBuffer(glContext.ARRAY_BUFFER, vertexBuffer);
				glContext.vertexAttribPointer(prg.vertexPositionAttribute, 3, glContext.FLOAT, false, 0, 0);
				glContext.bindBuffer(glContext.ARRAY_BUFFER, textCoordsBuffer);
				glContext.vertexAttribPointer(prg.textureCoordsAttribute, 2, glContext.FLOAT, false, 0, 0);
				glContext.bindBuffer(glContext.ARRAY_BUFFER, tangentsBuffer);
				glContext.vertexAttribPointer(prg.tangentsAttribute, 3, glContext.FLOAT, false, 0, 0);
				
				glContext.activeTexture(glContext.TEXTURE0);
				glContext.bindTexture(glContext.TEXTURE_2D, texColorTab[currentColorMapID]);
				glContext.uniform1i(prg.uColorTexture, 0);

				glContext.activeTexture(glContext.TEXTURE1);
				glContext.bindTexture(glContext.TEXTURE_2D, texBrokenTab[0]);
				glContext.uniform1i(prg.uNormalMap, 0);

				glContext.activeTexture(glContext.TEXTURE2);
				glContext.bindTexture(glContext.TEXTURE_2D, texNormalTab[currentNormalMapID-1]);
				glContext.uniform1i(prg.uNormalMap, 1);

				glContext.bindBuffer(glContext.ELEMENT_ARRAY_BUFFER, indexBuffer);
				glContext.drawElements(glContext.TRIANGLE_STRIP, indices.length, glContext.UNSIGNED_SHORT,0);
			}
			function initWebGL(){
				glContext = getGLContext('webgl-canvas');
				initProgram();
				initBuffers();
				initMaterialProperties();
				for( var index=0; index<=maxSample; ++index ) {
					var fileName = "7digits/";
					initTextureWithImage(fileName+index+".png", texColorTab);
				}
				initTextureWithImage("glass.jpg", texBrokenTab);

				renderLoop();
			}
		</script>
		<script>
			function changeColorMap(){
				if( currentColorMapID < maxSample ) ++currentColorMapID;
				else currentColorMapID = 0;
				document.getElementById("spanID1").innerHTML = "<button id='colorMapButton' onclick='changeColorMap()'>Texture [" + currentColorMapID + "]</button>";
			}
			function changeNormalMap(){
				if( currentNormalMapID < maxSample ) ++currentNormalMapID;
				else currentNormalMapID = 1;
				document.getElementById("spanID2").innerHTML = "<button id='normalMapButton' onclick='changeNormalMap()'>normal map [" + currentNormalMapID + "]</button>";
			}
			function sliderRotLightRadiusChanged(){
				lightRotRadius = document.getElementById("rotLightRadiusSlider").value;
            }
            function sliderHorizon(){
				hAngle = document.getElementById("sliderHorizon").value;
				document.getElementById("spanH").innerHTML = "<span id=\"spanH\"><label> value : "+hAngle+" </label></span>";
			}

			function sliderVertical(){
				vAngle = document.getElementById("sliderVertical").value;
				document.getElementById("spanV").innerHTML = "<span id=\"spanV\"><label> value : "+vAngle+" </label></span>";
			}
			function sliderBrokenIntensityChanged(){
				brokenGlassIntensity = document.getElementById("brokenGlassIntensity").value;
				document.getElementById("spanBrok").innerHTML = "<span id=\"spanBrok\"><label> Broken Intensity : "+brokenGlassIntensity+" %</label></span>";
			}

			function sliderLightIntensityChanged(){
				currentLightIntensity = document.getElementById("lightIntensitySlider").value;
			}

			function sliderImgIndice(){
				currentColorMapID = document.getElementById("idImage").value;
				document.getElementById("spanIndiceImage").innerHTML = "<span id=\"spanIndiceImage\"><label>"+currentColorMapID+"</label></span>";
			}
		</script>
	</head>
	<body onload="initWebGL()">
        <script>displayTitle("Infographie - Labo 1 - MONNET PAYSANT - Génération images Discovery", 1,1,1,1,1,1,1);</script>
		<nav>
		<a href="#webgl-canvas">Aller directement aux manipulations.</a></nav>
		<h2>Choix du sujet </h2>
        <p>Je suis l'explication du choix du sujet</p>
		<hr>
        <h2>Objectifs  </h2>
        <ul>
            <li>je suis l'élément 1 de la liste des objectifs.</li>
        </ul>
		<hr>
		<h2>Explications de la démarche  </h2>
        <p>je suis la démarche</p>
		<hr>
		<h2>Manipulations  </h2><br>
        <p>
			<input id="useColorMapCheckBox" type="checkbox" hidden checked=true onchange="changeTheMapUse( 'useColorMapCheckBox', 'colorMapButton' )">Texture</input>
			<input id="userBrokenGlassCheckBox" type="checkbox" hidden checked=true disabled=true onchange="changeTheMapUse( 'userBrokenGlassCheckBox', 'normalMapButton' )">BrokenGlass</input>
			<br />
			<span id="spanID1"><button id="colorMapButton" onclick="changeColorMap()">Texture [1]</button></span>

			<input type="range" id="brokenGlassIntensity" value="50" min="0" step="50" max="100" oninput="sliderBrokenIntensityChanged();">
			<span id="spanBrok"><label> Broken Intensity : 50 %</label></span>

		</p>
		<input id="animateCheckBox" type="checkbox" checked=true onchange="animateObject()">Rotation de la source de lumière</input> de rayon : 1.0
		<input type="range" id="rotLightRadiusSlider" value="3" min="1" max="5" step="2" oninput="sliderRotLightRadiusChanged();">5.0<br />
		Intensité de la lumière : 13.0<input type="range" id="lightIntensitySlider" value="13" step="7" min="13" max="27" oninput="sliderLightIntensityChanged();">27.0<br />
        
        Inclinaison du plan Verticale : -15°<input type="range" id="sliderHorizon" value="0"  step="15" min="-15" max="15" oninput="sliderHorizon();">15°
			<span id="spanH"><label> value : 0</label></span>
			<br>
			Inclinaison du plan Horizontal : -15°<input type="range" id="sliderVertical" step="15" value="0" min="-15" max="15" oninput="sliderVertical();">15°
			<span id="spanV"><label> value : 0</label></span>
            <br>
        <!-- WebGL canvas -->
		<canvas id="webgl-canvas" width="400" height="400">
			HTML5 is not supported
		</canvas>
		<a id="download" download="myImage.png" href="" onclick="download_img(this);">Download</a>
		<hr>
		<h3>Automatisation</h3>
		Choisissez indice image : <input type="range" id="idImage" value="1" min="0" max="11" step="1" oninput="sliderImgIndice();"><span id="spanIndiceImage"><label> 1</label></span><br>
		<input type="button" name="btnStart" id="btnStart" onclick="start_process();" value="C'est Parti !">

		<script>
			function start_process(){
				let indexTosave=0;
				//parcours texture vers
				for(brokenGlassIntensity=0;brokenGlassIntensity<=100;brokenGlassIntensity+=50){
					//parcours rot raduis
					for(lightRotRadius=1;lightRotRadius<=5;lightRotRadius+=2){
						//parcrous intensité lumière
						for(currentLightIntensity=13;currentLightIntensity<=27;currentLightIntensity+=7){
							//parcours vertical
							for(vAngle=-15;vAngle<=15;vAngle+=15){
								//parcours horizontal
								for(hAngle=-15;hAngle<=15;hAngle+=15){
									saveImage("webgl-canvas",currentColorMapID+"_"+(indexTosave++)+".png");
									drawScene();
								}
							}
						}
					}

				}
			}

			//depuis : https://nosmoking.developpez.com/demos/js/canvas-download.html
			function saveImage(idCanvas, nomFichier) {
				// nom du fichier pour l'enregistrement
				const nomFile = nomFichier || "image.png";
				// récup. de l'élément <canvas>
				const canvas = document.getElementById(idCanvas);
				let dataImage;
				// pour IE et Edge c'est simple !!!
				// https://technet.microsoft.com/en-us/windows/hh771732(v=vs.60)
				if (canvas.msToBlob) {
				// crée un objet blob contenant le dessin du canvas
				dataImage = canvas.msToBlob();
				// affiche l'invite d'enregistrement
				window.navigator.msSaveBlob(dataImage, nomFile);
				}
				else {
				// création d'un lien HTML5 download
				const lien = document.createElement("A");
				// récup. des data de l'image
				dataImage = canvas.toDataURL("image/png");
				// affectation d'un nom à l'image
				lien.download = nomFile;
				// modifie le type de données
				dataImage = dataImage.replace("image/png", "image/octet-stream");
				// affectation de l'adresse
				lien.href = dataImage;
				// ajout de l'élément
				document.body.appendChild(lien);
				// simulation du click
				lien.click();
				// suppression de l'élément devenu inutile
				document.body.removeChild(lien);
				}
			}

			//pour le lien
			function download_img(el) {
			var canvas = document.getElementById("webgl-canvas");
			var ctx = canvas.getContext("3d");
			var imageURI = canvas.toDataURL('image/png');
			el.href = imageURI;
			};
		</script>
	</body>
</html>